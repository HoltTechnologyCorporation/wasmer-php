<!DOCTYPE html>

<html lang="en" prefix="og: http://ogp.me/ns#">
    <head>
        <base href="./../../" />
        <title>Source of Wasm\Cache\Filesystem from php-ext-wasm</title>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta http-equiv="content-type" content="text/javascript; charset=utf-8" />
        <meta http-equiv="content-type" content="text/css; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link rel="preload" href="./css/main.css" as="style" />
        <link rel="preload" href="./javascript/prism.js" as="script" />
        <link rel="preload" href="./javascript/prism-hooks.js" as="script" />
        <link rel="preload" href="./javascript/search.elm.js" as="script" />
        <link rel="preload" href="./javascript/search-index.js" as="script" />
        <link rel="preload" href="./javascript/search-metadata.js" as="script" />
        <link rel="preload" href="./javascript/application.js" as="script" />

        <link rel="stylesheet" href="./css/main.css" media="all" />
        <link rel="stylesheet" href="./css/prism.css" media="all" />

        <link rel="icon" type="image/png" href="./resource/logo_32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="./resource/logo_192x192.png" sizes="192x192" />

        <meta name="generator" content="Kitab (https://hoa-project.net/)" />
        <meta name="description" content="Source of Wasm\Cache\Filesystem from php-ext-wasm">

        <meta property="og:title" content="Source of Wasm\Cache\Filesystem from php-ext-wasm" />
        <meta property="og:type" content="website" />
        <meta proprery="og:image" content="https://github.com/wasmerio.png" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:creator" content="@hoaproject" />
        <meta name="twitter:text:title" content="Source of Wasm\Cache\Filesystem from php-ext-wasm" />
        <meta name="twitter:image:src" content="https://github.com/wasmerio.png" />
        <meta name="twitter:image:alt" content="php-ext-wasm" />
    </head>
    <body>
        <div id="search" role="search">
            <div>
                <input type="search" placeholder="Initializing searchâ€¦" disabled />
            </div>
        </div>

        <main>
            <aside>
    <header>
        <a href="./">
            <img src="https://github.com/wasmerio.png" alt="Home" />
        </a>
    </header>
</aside>

<article>
    <pre id="L" data-line="," class="line-numbers"><code class="language-php no-wrap-hooks">&lt;?php

declare(strict_types = 1);

namespace Wasm\Cache;

use DirectoryIterator;
use Wasm\Module;

/**
 * An on-disk cache implementation.
 *
 * # Examples
 *
 * ```php,ignore
 * const KEY = 'foobar';
 * const CACHE_DIRECTORY = '/tmp/php.wasm.cache/';
 *
 * $cache = new Wasm\Cache\Filesystem(CACHE_DIRECTORY);
 *
 * // The cache exists. Let's fetch the module.
 * if ($cache-&gt;has(KEY)) {
 *     $module = $cache-&gt;get(KEY);
 * }
 * // The cache doesn't exist. Let's compile and store the module.
 * else {
 *     $module = new Wasm\Module('my_program.wasm');
 *     $cache-&gt;set(KEY, $module);
 * }
 *
 * // Let's continue as usual: Instantiate the module, and invoke functions on it.
 * $instance = $module-&gt;instantiate();
 * $instance-&gt;sum(1, 2);
 * ```
 */
class Filesystem implements CacheInterface
{
    /**
     * Represents the cache file extension.
     */
    const CACHE_SUFFIX = '.module.wasm.cache';

    /**
     * The cache directory where cache files are located.
     */
    private $cacheDirectory;

    /**
     * Builds a cache in a specific directory.
     *
     * A `Wasm\Cache\Exception` is thrown if the cache directory is not a
     * valid directory, nor readable, nor writable.
     */
    public function __construct(string $cacheDirectory)
    {
        $cacheDirectory = rtrim($cacheDirectory, '/\\');

        if (false === is_dir($cacheDirectory)) {
            throw new Exception(&quot;The cache directory `$cacheDirectory` is not a directory.&quot;);
        }

        if (false === is_readable($cacheDirectory)) {
            throw new Exception(&quot;The cache directory `$cacheDirectory` is not readable.&quot;);
        }

        if (false === is_writable($cacheDirectory)) {
            throw new Exception(&quot;The cache directory `$cacheDirectory` is not writable.&quot;);
        }

        $this-&gt;cacheDirectory = $cacheDirectory;
    }

    /**
     * Gets a module from the cache based on its key if it exists and is
     * valid, the default value otherwise.
     */
    public function get($key, $default = null)
    {
        if (false === $this-&gt;has($key)) {
            return $default;
        }

        $serialized_content = file_get_contents($this-&gt;getCacheFile($key));

        if (false === $serialized_content) {
            return $default;
        }

        $module = unserialize($serialized_content, [Module::class]);

        if (false === $module) {
            return $default;
        }

        return $module;
    }

    /**
     * Sets a module object into the cached.
     *
     * The TTL is not taken into account yet.
     */
    public function set($key, $value, $ttl = null)
    {
        if (!($value instanceof Module)) {
            throw new InvalidArgumentException('The cache can only store `' . Module::class . '` instances.');
        }

        $filePath = $this-&gt;getCacheFile($key);

        file_put_contents($filePath, serialize($value));
    }

    /**
     * Deletes a module from the cache based on its key.
     */
    public function delete($key)
    {
        if (false === $this-&gt;has($key)) {
            return;
        }

        unlink($this-&gt;getCacheFile($key));
    }

    /**
     * Clears the cache, i.e. remove all cache files.
     */
    public function clear()
    {
        $iterator = new DirectoryIterator($this-&gt;cacheDirectory);
        $extensionPattern = '/' . preg_quote(self::CACHE_SUFFIX) . '$/';

        foreach ($iterator as $file) {
            if (false === $file-&gt;isFile()) {
                continue;
            }

            if (0 === preg_match($extensionPattern, $file-&gt;getBaseName())) {
                continue;
            }

            unlink($file-&gt;getPathName());
        }
    }

    /**
     * Not implemented yet.
     */
    public function getMultiple($keys, $default = null)
    {
        throw new Exception('`' . __METHOD__ . '` not implemented yet.');
    }

    /**
     * Not implemented yet.
     */
    public function setMultiple($values, $ttl = null)
    {
        throw new Exception('`' . __METHOD__ . '` not implemented yet.');
    }

    /**
     * Not implemented yet.
     */
    public function deleteMultiple($keys)
    {
        throw new Exception('`' . __METHOD__ . '` not implemented yet.');
    }

    /**
     * Checks whether a cache item exists for a given key.
     */
    public function has($key)
    {
        return file_exists($this-&gt;getCacheFile($key));
    }

    /**
     * Gets a cache file name based on a key, whether it exists or not.
     */
    private function getCacheFile(string $key)
    {
        return $this-&gt;cacheDirectory . DIRECTORY_SEPARATOR . $key . self::CACHE_SUFFIX;
    }
}
</code></pre>
</article>
        </main>

        <script src="./javascript/prism.js"></script>
        <script src="./javascript/prism-hooks.js"></script>
        <script src="./javascript/search.elm.js" defer></script>
        <script src="./javascript/search-index.js" defer></script>
        <script src="./javascript/search-metadata.js" defer></script>
        <script src="./javascript/application.js" defer></script>
    </body>
</html>
