<!DOCTYPE html>

<html lang="en" prefix="og: http://ogp.me/ns#">
    <head>
        <base href="./../" />
        <title>Source of Wasm\Module from php-ext-wasm</title>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta http-equiv="content-type" content="text/javascript; charset=utf-8" />
        <meta http-equiv="content-type" content="text/css; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link rel="preload" href="./css/main.css" as="style" />
        <link rel="preload" href="./javascript/prism.js" as="script" />
        <link rel="preload" href="./javascript/prism-hooks.js" as="script" />
        <link rel="preload" href="./javascript/search.elm.js" as="script" />
        <link rel="preload" href="./javascript/search-index.js" as="script" />
        <link rel="preload" href="./javascript/search-metadata.js" as="script" />
        <link rel="preload" href="./javascript/application.js" as="script" />

        <link rel="stylesheet" href="./css/main.css" media="all" />
        <link rel="stylesheet" href="./css/prism.css" media="all" />

        <link rel="icon" type="image/png" href="./resource/logo_32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="./resource/logo_192x192.png" sizes="192x192" />

        <meta name="generator" content="Kitab (https://hoa-project.net/)" />
        <meta name="description" content="Source of Wasm\Module from php-ext-wasm">

        <meta property="og:title" content="Source of Wasm\Module from php-ext-wasm" />
        <meta property="og:type" content="website" />
        <meta proprery="og:image" content="https://github.com/wasmerio.png" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:creator" content="@hoaproject" />
        <meta name="twitter:text:title" content="Source of Wasm\Module from php-ext-wasm" />
        <meta name="twitter:image:src" content="https://github.com/wasmerio.png" />
        <meta name="twitter:image:alt" content="php-ext-wasm" />
    </head>
    <body>
        <div id="search" role="search">
            <div>
                <input type="search" placeholder="Initializing searchâ€¦" disabled />
            </div>
        </div>

        <main>
            <aside>
    <header>
        <a href="./">
            <img src="https://github.com/wasmerio.png" alt="Home" />
        </a>
    </header>
</aside>

<article>
    <pre id="L" data-line="," class="line-numbers"><code class="language-php no-wrap-hooks">&lt;?php

declare(strict_types = 1);

namespace Wasm;

use RuntimeException;
use Serializable;

/**
 * The `Module` class allows to compile WebAssembly bytes into a WebAssembly
 * module.
 *
 * To get a ready to use WebAssembly program, one first needs to compile the
 * bytes into a module, and second to instantiate the module. This class
 * addresses the first step. To instantiate the module, call the `instantiate`
 * method.
 *
 * # Examples
 *
 * To compile the bytes in `my_program.wasm` to a WebAssembly module:
 *
 * ```php,ignore
 * $module = new Wasm\Module('my_program.wasm');
 * $instance = $module-&gt;instantiate();
 * $result = $instance-&gt;sum(1, 2);
 * ```
 *
 * To compile the module only once per multiple PHP requests, one will write:
 *
 * ```php,ignore
 * $module = new Wasm\Module('my_program.wasm', Wasm\Module::PERSISTENT);
 * $instance = $module-&gt;instantiate();
 * $result = $instance-&gt;sum(1, 2);
 * ```
 */
class Module implements Serializable
{
    /**
     * Instructs that the underlying module resource must be persistent.
     */
    const PERSISTENT = true;

    /**
     * Instructs that the underlying module resource must **not** be
     * persistent.
     */
    const VOLATILE = false;

    /**
     * The Wasm module.
     */
    private $wasmModule;

    /**
     * Compiles WebAssembly bytes from a file into a module.
     *
     * The `$persistence` flag allows to compile the module only once per
     * multiple PHP request executions: It can dramatically improves the set
     * up of your WebAssembly program when it is quite large.
     *
     * When the `$persistence` flag is turned to `self::PERSISTENT`, the given
     * file will be read only once and the module will be compiled only
     * once. The underlying `wasm_module` resource will be registered as
     * persistent across PHP requests. As a side-effect, if the file content
     * changes, the module will not be re-compiled.
     *
     * To force to compile a new fresh module, the `$persistence` flag must be
     * turned to `self::VOLATILE`, which is the default value. See also the
     * `wasm_module_clean_up_persistent_resources` function.
     *
     * The constructor throws a `RuntimeException` when the given file does
     * not exist, or is not readable.
     *
     * The constructor also throws a `RuntimeException` when the compilation
     * failed.
     */
    public function __construct(string $filePath, bool $persistence = self::VOLATILE)
    {
        if (false === file_exists($filePath)) {
            throw new RuntimeException(&quot;File path to Wasm binary `$filePath` does not exist.&quot;);
        }

        if (false === is_readable($filePath)) {
            throw new RuntimeException(&quot;File `$filePath` is not readable.&quot;);
        }

        $wasmBytes = wasm_fetch_bytes($filePath);
        $wasmModuleUniqueIdentifier = null;

        if (self::PERSISTENT === $persistence) {
            $wasmModuleUniqueIdentifier = $this-&gt;getUniqueIdentifier($filePath);
        }

        $this-&gt;wasmModule = wasm_compile($wasmBytes, $wasmModuleUniqueIdentifier);

        if (null === $this-&gt;wasmModule) {
            throw new RuntimeException(
                &quot;An error happened while compiling the module `$filePath`:\n    &quot; .
                str_replace(&quot;\n&quot;, &quot;\n    &quot;, wasm_get_last_error())
            );
        }
    }

    /**
     * Generates a unique identifier for this module.
     *
     * This is used when the module needs to be persistent: It identifies the
     * module resource by a unique string.
     */
    protected function getUniqueIdentifier(string $filePath): string
    {
        $out = realpath($filePath);

        if (true === function_exists('hash')) {
            $out = hash('sha3-512', $out);
        }

        return $out;
    }

    /**
     * Instantiates the module.
     *
     * # Examples
     *
     * The following code:
     *
     * ```php,ignore
     * $module = new Wasm\Module('my_program.wasm');
     * $instance = $module-&gt;instantiate();
     * ```
     *
     * is a shortcut to:
     *
     * ```php,ignore
     * $module = new Wasm\Module('my_program.wasm');
     * $instance = Wasm\Instance::fromModule($module);
     * ```
     */
    public function instantiate(): Instance
    {
        return Instance::fromModule($this);
    }

    /**
     * Returns the inner resource representing the module.
     */
    public function intoResource()
    {
        return $this-&gt;wasmModule;
    }

    /**
     * Serializes this module with the standard `serialize` PHP function.
     *
     * # Examples
     *
     * ```php,ignore
     * $module = new Wasm\Module('my_program.wasm');
     * $serialized_module = serialize($module);
     * ```
     */
    public function serialize(): string
    {
        $serializedModule = wasm_module_serialize($this-&gt;intoResource());

        if (null === $serializedModule) {
            throw new RuntimeException('Failed to serialize the module.');
        }

        return $serializedModule;
    }

    /**
     * Deserializes a (supposedly) serialized module, with the standard
     * `unserialize` PHP function.
     *
     * This method throws a `RuntimeException` if the deserialization failed.
     *
     * # Examples
     *
     * ```php,ignore
     * $module = new Wasm\Module('my_program.wasm');
     * $serialized_module = serialize($module);
     * unset($module);
     *
     * $module = unserialize($serialized_module, [Wasm\Module::class]);
     * $instance = $module-&gt;instantiate();
     * $result = $instance-&gt;sum(1, 2);
     * ```
     */
    public function unserialize($serializedModule)
    {
        $module = wasm_module_deserialize($serializedModule);

        if (null === $module) {
            throw new RuntimeException('Failed to deserialize the module.');
        }

        $this-&gt;wasmModule = $module;
    }
}
</code></pre>
</article>
        </main>

        <script src="./javascript/prism.js"></script>
        <script src="./javascript/prism-hooks.js"></script>
        <script src="./javascript/search.elm.js" defer></script>
        <script src="./javascript/search-index.js" defer></script>
        <script src="./javascript/search-metadata.js" defer></script>
        <script src="./javascript/application.js" defer></script>
    </body>
</html>
