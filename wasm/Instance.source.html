<!DOCTYPE html>

<html lang="en" prefix="og: http://ogp.me/ns#">
    <head>
        <base href="./../" />
        <title>Source of Wasm\Instance from php-ext-wasm</title>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta http-equiv="content-type" content="text/javascript; charset=utf-8" />
        <meta http-equiv="content-type" content="text/css; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link rel="preload" href="./css/main.css" as="style" />
        <link rel="preload" href="./javascript/prism.js" as="script" />
        <link rel="preload" href="./javascript/prism-hooks.js" as="script" />
        <link rel="preload" href="./javascript/search.elm.js" as="script" />
        <link rel="preload" href="./javascript/search-index.js" as="script" />
        <link rel="preload" href="./javascript/search-metadata.js" as="script" />
        <link rel="preload" href="./javascript/application.js" as="script" />

        <link rel="stylesheet" href="./css/main.css" media="all" />
        <link rel="stylesheet" href="./css/prism.css" media="all" />

        <link rel="icon" type="image/png" href="./resource/logo_32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="./resource/logo_192x192.png" sizes="192x192" />

        <meta name="generator" content="Kitab (https://hoa-project.net/)" />
        <meta name="description" content="Source of Wasm\Instance from php-ext-wasm">

        <meta property="og:title" content="Source of Wasm\Instance from php-ext-wasm" />
        <meta property="og:type" content="website" />
        <meta proprery="og:image" content="https://github.com/wasmerio.png" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:creator" content="@hoaproject" />
        <meta name="twitter:text:title" content="Source of Wasm\Instance from php-ext-wasm" />
        <meta name="twitter:image:src" content="https://github.com/wasmerio.png" />
        <meta name="twitter:image:alt" content="php-ext-wasm" />
    </head>
    <body>
        <div id="search" role="search">
            <div>
                <input type="search" placeholder="Initializing search…" disabled />
            </div>
        </div>

        <main>
            <aside>
    <header>
        <a href="./">
            <img src="https://github.com/wasmerio.png" alt="Home" />
        </a>
    </header>
</aside>

<article>
    <pre id="L" data-line="," class="line-numbers"><code class="language-php no-wrap-hooks">&lt;?php

declare(strict_types = 1);

namespace Wasm;

use RuntimeException;
use WasmArrayBuffer;

/**
 * The `Instance` class allows to compile WebAssembly bytes into a module, and
 * instantiate the module directly. Then, it is possible to call exported
 * functions with a user-friendly API.
 *
 * To get a ready to use WebAssembly program, one first needs to compile the
 * bytes into a module, and second to instantiate the module. This class
 * allows to combine these two steps: The constructor compiles and
 * instantiates the module in a single-pass.
 *
 * # Examples
 *
 * ```php,ignore
 * $instance = new Wasm\Instance('my_program.wasm');
 * $result = $instance-&gt;sum(1, 2);
 * ```
 *
 * That simple.
 */
class Instance
{
    /**
     * The Wasm instance.
     */
    protected $wasmInstance;

    /**
     * A Wasm buffer over the instance memory if any.
     */
    protected $wasmMemoryBuffer;

    /**
     * Compiles and instantiates a WebAssembly binary file.
     *
     * The constructor throws a `RuntimeException` when the given file does
     * not exist, or is not readable.
     *
     * The constructor also throws a `RuntimeException` when the compilation
     * or the instantiation failed.
     */
    public function __construct(string $filePath)
    {
        if (false === file_exists($filePath)) {
            throw new RuntimeException(&quot;File path to Wasm binary `$filePath` does not exist.&quot;);
        }

        if (false === is_readable($filePath)) {
            throw new RuntimeException(&quot;File `$filePath` is not readable.&quot;);
        }

        $wasmBytes = wasm_fetch_bytes($filePath);
        $this-&gt;wasmInstance = wasm_new_instance($wasmBytes);

        if (null === $this-&gt;wasmInstance) {
            throw new RuntimeException(
                &quot;An error happened while compiling or instantiating the module `$filePath`:\n    &quot; .
                str_replace(&quot;\n&quot;, &quot;\n    &quot;, wasm_get_last_error())
            );
        }
    }

    /**
     * Instantiates a WebAssembly module.
     *
     * This method throws a `RuntimeException` when the instantiation failed.
     *
     * # Examples
     *
     * ```php,ignore
     * $module = new Wasm\Module('my_program.wasm');
     * $instance = Wasm\Instance::fromModule($module);
     * $result = $instance-&gt;sum(1, 2);
     * ```
     */
    public static function fromModule(Module $module): self
    {
        // Using an anonymous class allows to overwrite the constructor,
        // and to inject the `wasm_instance` resource and the file path.
        // From a type point of view, there is no difference.
        return new class($module) extends Instance {
            public function __construct(Module $module) {
                $this-&gt;wasmInstance = wasm_module_new_instance($module-&gt;intoResource());

                if (null === $this-&gt;wasmInstance) {
                    throw new RuntimeException(
                        &quot;An error happened while instanciating the module:\n    &quot; .
                        str_replace(&quot;\n&quot;, &quot;\n    &quot;, wasm_get_last_error())
                    );
                }
            }
        };
    }

    /**
     * Returns an array buffer over the instance memory if any.
     *
     * It is recommended to combine the array buffer with typed arrays
     * `Wasm\TypedArray`.
     *
     * # Examples
     *
     * ```php,ignore
     * $instance = new Wasm\Instance('my_program.wasm');
     * $memory = $instance-&gt;getMemoryBuffer();
     *
     * assert($memory instanceof WasmArrayBuffer);
     * ```
     */
    public function getMemoryBuffer(): ?WasmArrayBuffer
    {
        if (null === $this-&gt;wasmMemoryBuffer) {
            $this-&gt;wasmMemoryBuffer = wasm_get_memory_buffer($this-&gt;wasmInstance);
        }

        return $this-&gt;wasmMemoryBuffer;
    }

    /**
     * Calls an exported function.
     *
     * An exported function is a function that is exported by the WebAssembly
     * binary.
     *
     * The provided arguments are automatically converted to WebAssembly
     * compliant values. If arguments are missing, or if too much arguments
     * are given, an `InvocationException` exception will be thrown. If one
     * argument has a non-compliant type, an `InvocationException` exception
     * will also be thrown.
     *
     * **Reminder**: Value types are given by the following constants:
     *  * `Wasm\I32` for integer on 32 bits,
     *  * `Wasm\I64` for integer on 64 bits,
     *  * `Wasm\F32` for float on 32 bits,
     *  * `Wasm\F64` for float on 64 bits.
     *
     * # Examples
     *
     * ```php,ignore
     * $instance = new Wasm\Instance('my_program.wasm');
     * $value = $instance-&gt;sum(1, 2);
     * ```
     */
    public function __call(string $name, array $arguments)
    {
        $signature = wasm_get_function_signature($this-&gt;wasmInstance, $name);

        if (null === $signature) {
            $error = wasm_get_last_error();

            if (null === $error) {
                throw new InvocationException(&quot;Function `$name` does not exist.&quot;);
            } else {
                throw new InvocationException(&quot;Cannot invoke the function `$name` because: $error.&quot;);
            }
        }

        $number_of_expected_arguments = count($signature) - 1;
        $number_of_given_arguments = count($arguments);
        $diff = $number_of_expected_arguments - $number_of_given_arguments;

        if ($diff &gt; 0) {
            throw new InvocationException(
                &quot;Missing $diff argument(s) when calling `$name`: &quot; .
                &quot;Expect $number_of_expected_arguments arguments, &quot; .
                &quot;given $number_of_given_arguments.&quot;
            );
        } elseif ($diff &lt; 0) {
            $diff = abs($diff);

            throw new InvocationException(
                &quot;Given $diff extra argument(s) when calling `$name`: &quot; .
                &quot;Expect $number_of_expected_arguments arguments, &quot; .
                &quot;given $number_of_given_arguments.&quot;
            );
        }

        $wasmArguments = [];

        foreach ($arguments as $i =&gt; $argument) {
            $s = $i + 1;

            switch ($signature[$i]) {
                case I32:
                    if (!is_int($argument)) {
                        throw new InvocationException(&quot;Argument #$s of `$name` must be a `i32` (integer).&quot;);
                    }

                    $wasmArguments[] = wasm_value(I32, $argument);

                    break;

                case I64:
                    if (!is_int($argument)) {
                        throw new InvocationException(&quot;Argument #$s of `$name` must be a `i64` (integer).&quot;);
                    }

                    $wasmArguments[] = wasm_value(I64, $argument);

                    break;

                case F32:
                    if (!is_float($argument)) {
                        throw new InvocationException(&quot;Argument #$s of `$name` must be a `f32` (float).&quot;);
                    }

                    $wasmArguments[] = wasm_value(F32, $argument);

                    break;

                case F64:
                    if (!is_float($argument)) {
                        throw new InvocationException(&quot;Argument #$s of `$name` must be a `f64` (float).&quot;);
                    }

                    $wasmArguments[] = wasm_value(F64, $argument);

                    break;

                default:
                    throw new InvocationException(&quot;Unknown argument type `$signature[$i]` at position #$s of `$name`.&quot;);
            }
        }

        $result = wasm_invoke_function(
            $this-&gt;wasmInstance,
            $name,
            $wasmArguments
        );

        if (false === $result) {
            throw new InvocationException(&quot;Got an error when invoking `$name`.&quot;);
        }

        return $result;
    }
}

/**
 * An `InvocationException` exception is thrown when a function is invoked on
 * a Wasm instance, and failed.
 */
final class InvocationException extends RuntimeException {}
</code></pre>
</article>
        </main>

        <script src="./javascript/prism.js"></script>
        <script src="./javascript/prism-hooks.js"></script>
        <script src="./javascript/search.elm.js" defer></script>
        <script src="./javascript/search-index.js" defer></script>
        <script src="./javascript/search-metadata.js" defer></script>
        <script src="./javascript/application.js" defer></script>
    </body>
</html>
